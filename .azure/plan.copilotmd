# Azure Container Apps (Sweden Central, Serverless GPU T4) 部署计划

目标：在 Sweden Central 创建 Azure Container Apps Environment（启用 serverless GPU T4 workload profile），部署一个包含两个模型的 Gradio demo：
- microsoft/Dayhoff-3b-GR-HM-c（生成蛋白序列）
- microsoft/bioemu（可选：对生成序列做可运行性验证 + 3D 预览）

> 说明：GPU 需要先申请配额（quota）。并且为了减少 GPU 冷启动，建议镜像放在 ACR。

## 0. 先决条件
- 已安装并登录 Azure CLI：`az login`
- 已选择订阅：`az account set -s <SUBSCRIPTION_ID>`
- 已安装 Container Apps 扩展：`az extension add -n containerapp --upgrade`
- 已申请 Container Apps serverless GPU 配额（T4 / Consumption-GPU-NC8as-T4）

## 1. 构建并推送镜像到 ACR
1) 创建资源组（示例）

```bash
az group create -n rg-proteinai-aca -l swedencentral
```

2) 创建 ACR（示例）

```bash
az acr create -g rg-proteinai-aca -n <ACR_NAME_UNIQUE> --sku Standard
```

3) 构建并推送镜像（建议用 ACR build）

```bash
az acr build -g rg-proteinai-aca -r <ACR_NAME_UNIQUE> -t proteinai-demo:latest -f dayhoff_demo/Dockerfile dayhoff_demo
```

最终镜像：`<ACR_NAME_UNIQUE>.azurecr.io/proteinai-demo:latest`

## 2. 部署基础设施 + Container App（Bicep）
1) 编辑参数文件：`infra/main.bicepparam`
- `image` 改成你的 ACR 镜像（例如：`myacr.azurecr.io/proteinai-demo:latest`）
- 如需要 Hugging Face 权限，填 `hfToken`

2) 部署

```bash
az deployment group create -g rg-proteinai-aca -f infra/main.bicep -p infra/main.bicepparam
```

3) 获取访问 URL

```bash
az deployment group show -g rg-proteinai-aca -n <DEPLOYMENT_NAME> --query properties.outputs.containerAppUrl.value -o tsv
```

## 3. 运行与验证
- 打开 `containerAppUrl`，在 UI 中点击 **Generate** 生成序列（Dayhoff）
- 可选：点击 **Validate with BioEmu** 运行 BioEmu

## 4. 常见问题
- 冷启动很慢：首次拉镜像 + 首次拉 HF 权重耗时较长。优先把镜像放 ACR，并保持 `minReplicas=1`。
- HF 下载受限：在 `hfToken` 里填 `HF_TOKEN`。
- GPU 不可用：通常是 quota 未开通或 workload profile 未正确创建（`Consumption-GPU-NC8as-T4`）。
